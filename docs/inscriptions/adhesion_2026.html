<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bulletin d’adhésion 2026 – Crécyvélo 77</title>

  <style>
    :root{
      --pageW: 210mm;
      --border:#cfcfcf;
      --muted:#666;
      --bg:#f2f2f2;
      --err:#b00000;
      --ok:#12a454;
    }

    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
    }

    /* A4 width on screen, height auto (no truncation) */
    .page{
      width: var(--pageW);
      /* height: 297mm;  <-- removed on purpose */
      min-height: 297mm; /* optional: keeps the “A4 feel” if content is short */
      margin: 16px auto;
      background:#fff;
      border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      border-radius: 10px;
      padding: 12mm;
      box-sizing: border-box;
      position: relative;
      overflow: visible;
    }

    @media (max-width: 980px){
      .page{
        width: calc(100vw - 16px);
        min-height: unset;
        margin: 0 auto;
        border-radius: 0;
        box-shadow: none;
        overflow: visible;
        padding: 14px;
      }
    }

    h1{ font-size: 18px; margin: 0 0 4px; font-weight: 900; }
    .subtitle{ margin: 0 0 10px; color: var(--muted); font-size: 12px; }

    fieldset{
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 7px;
      margin: 6px 0;
    }
    legend{ font-weight: 500; padding: 0 6px; font-size: 13px; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .full{ grid-column: 1 / -1; }

    label{ display:block; font-weight: 500; margin-bottom: 4px; font-size: 12px; }

    input[type="text"],
    input[type="date"],
    input[type="email"],
    input[type="tel"],
    input[type="file"],
    select{
      width:100%;
      border:1px solid #d0d0d0;
      border-radius:9px;
      padding:7px 10px;
      font-size:12.5px;
      box-sizing:border-box;
      background:#fff;
    }

    .choices{ display:flex; gap:12px; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:8px; font-weight:400; font-size:12px; }

    .hint{ font-size:11px; color:var(--muted); margin-top:4px; line-height:1.25; }
    .error{ font-size:12px; color:var(--err); margin-top:4px; line-height:1.25; }

    .actions{
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      padding:9px 14px;
      border-radius:10px;
      border:0;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{ background:var(--ok); color:#fff; }
    .btn-ghost{ background:#eee; }
    .hidden{ display:none !important; }

    /* Tarifs (compact) */
    .tarifs-wrap{ overflow:hidden; }
    .tarifs{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout: fixed;
    }
    .tarifs th{
      text-align:center;
      font-weight:600;
      padding:4px 6px;
      border-bottom:1px solid #d8d8d8;
      white-space:nowrap;
    }
    .tarifs td{
      padding:4px 6px;
      border-bottom:1px solid #eee;
      vertical-align:middle;
    }
    .tarifs .grp td{
      border-bottom:0;
      padding:7px 6px 3px;
      font-weight:600;
      font-style:italic;
      font-size:12px;
    }
    .tarifs .label{
      font-weight:600;
      white-space:nowrap;
      text-align:right;
      padding-right:10px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tarifs .price{
      text-align:center;
      white-space:nowrap;
    }
    .tarifs .radioPrice{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      font-size:12px;
    }
    .tarifs input[type="radio"]{
      transform: translateY(1px) scale(0.95);
    }
    .tarifs tr:nth-child(even):not(.grp){ background:#fafafa; }

    /* signature */
    .sigbox{
      border:1px solid #d0d0d0;
      border-radius:9px;
      padding:8px;
      background:#fff;
    }
    canvas{
      border:1px dashed #999;
      border-radius:8px;
      touch-action: none;
      display:block;
    }

    /* Print */
    @page{ size:A4; margin:10mm; }
    @media print{
      body{ background:#fff; }
      .page{
        width:auto;
        min-height:auto;
        margin:0;
        padding:0;
        border:none;
        box-shadow:none;
        border-radius:0;
      }
      .no-print{ display:none !important; }
      fieldset{ page-break-inside:avoid; }
    }
  </style>
</head>

<body>

<!-- PAGE FORMULAIRE -->
<div class="page" id="formPage">

  <h1>Bulletin d’adhésion 2026 – Crécyvélo 77</h1>
  <p class="subtitle">Merci de compléter les informations ci-dessous. Les champs marqués * sont obligatoires.</p>

  <form id="adhesionForm">

    <!-- 1. Identité -->
    <fieldset>
      <legend>1. Identité du licencié</legend>

      <div class="row2">
        <div>
          <label>Type d’adhésion *</label>
          <div class="choices">
            <label class="pill"><input type="radio" name="type_adhesion" value="renouvellement" required> Renouvellement</label>
            <label class="pill"><input type="radio" name="type_adhesion" value="premiere"> Première adhésion</label>
          </div>
        </div>

        <div>
          <label>Civilité *</label>
          <div class="choices">
            <label class="pill"><input type="radio" name="civilite" value="Madame" required> Madame</label>
            <label class="pill"><input type="radio" name="civilite" value="Monsieur"> Monsieur</label>
          </div>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Nom *</label>
          <input type="text" name="nom" autocomplete="family-name" required>
        </div>
        <div>
          <label>Prénom *</label>
          <input type="text" name="prenom" autocomplete="given-name" required>
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Nom de naissance</label>
          <input type="text" name="nom_naissance">
          <div class="hint">Optionnel (si différent du nom d’usage).</div>
        </div>
        <div>
          <label>Date de naissance *</label>
          <input type="date" name="date_naissance" required>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Commune de naissance *</label>
          <input type="text" name="commune_naissance" required>
        </div>

        <div id="wrap_departement_naissance">
          <label>Département de naissance *</label>
          <input type="text" name="departement_naissance" inputmode="numeric" placeholder="Ex: 77">
          <div class="hint">Requis si né(e) en France.</div>
        </div>

        <div>
          <label>Pays de naissance *</label>
          <select name="pays_naissance" id="pays_naissance" required>
            <option value="France" selected>France</option>
            <option value="Etranger">À l’étranger</option>
          </select>
        </div>
      </div>

      <div id="wrap_pays_etranger" class="hidden">
        <label>Pays (si né à l’étranger) *</label>
        <input type="text" name="pays_naissance_detail" placeholder="Ex: Belgique">
      </div>

      <div class="row2">
        <div>
          <label>N° de licence (6 chiffres)</label>
          <input type="text" name="licence" id="licence" inputmode="numeric" pattern="^[0-9]{6}$" placeholder="123456">
          <div class="hint" id="licence_hint">Optionnel en première adhésion. Obligatoire en renouvellement.</div>
        </div>
        <div></div>
      </div>

      <div class="error" id="identite_error" style="display:none;"></div>
    </fieldset>

    <!-- 2. Coordonnées -->
    <fieldset>
      <legend>2. Coordonnées</legend>

      <div class="row2">
        <div class="full">
          <label>Adresse *</label>
          <input type="text" name="adresse" autocomplete="street-address" required>
        </div>
        <div>
          <label>Code postal *</label>
          <input type="text" name="cp" autocomplete="postal-code" required>
        </div>
        <div>
          <label>Commune *</label>
          <input type="text" name="ville" autocomplete="address-level2" required>
        </div>
        <div>
          <label>Téléphone *</label>
          <input type="tel" name="telephone" autocomplete="tel" required>
        </div>
        <div>
          <label>Email *</label>
          <input type="email" name="email" autocomplete="email" required>
        </div>
      </div>
    </fieldset>

    <!-- 3. Informations sportives -->
    <fieldset>
      <legend>3. Informations sportives</legend>

      <label>Type de pratique *</label>
      <div class="choices">
        <label class="pill"><input type="checkbox" name="pratique" value="Route"> Route</label>
        <label class="pill"><input type="checkbox" name="pratique" value="VTT"> VTT</label>
        <label class="pill"><input type="checkbox" name="pratique" value="Gravel"> Gravel</label>
      </div>
      <div class="error" id="pratique_error" style="display:none;"></div>

      <label style="margin-top:8px;">Pratique du VAE *</label>
      <div class="choices">
        <label class="pill"><input type="radio" name="vae" value="Oui" required> Oui</label>
        <label class="pill"><input type="radio" name="vae" value="Non"> Non</label>
      </div>
    </fieldset>

    <!-- 4. Cotisations -->
    <fieldset>
      <legend>Montant des cotisations *</legend>
      <div class="hint">Choisir une seule ligne.</div>

			<div class="tarifs-wrap">
			  <table class="tarifs">
			    <thead>
			      <tr>
			        <th style="text-align:left; width:38%;"> </th>
			        <th style="width:20%;" id="col0">Mini-braquet</th>
			        <th style="width:20%;" id="col1">Petit-braquet</th>
			        <th style="width:22%;" id="col2">Grand-braquet</th>
			      </tr>
			    </thead>
			    <tbody id="tarifsBody">
			      <tr><td colspan="4" style="padding:8px;color:#666;">Chargement des tarifs…</td></tr>
			    </tbody>
			  </table>
			</div>

      <div class="row2" style="margin-top:6px;">
        <div>
          <label>Montant sélectionné</label>
          <input type="text" id="cotisation_affiche" readonly>
        </div>
        <div></div>
      </div>

      <div class="error" id="cotisation_error" style="display:none;"></div>

      <input type="hidden" name="cotisation_code" id="cotisation_code">
      <input type="hidden" name="cotisation_libelle" id="cotisation_libelle">
      <input type="hidden" name="cotisation_montant" id="cotisation_montant">
    </fieldset>

    <!-- Mode de règlement -->
    <fieldset>
      <legend>Mode de règlement *</legend>
      <div class="choices">
        <label class="pill"><input type="radio" name="reglement" value="Virement" required> Virement</label>
        <label class="pill"><input type="radio" name="reglement" value="Chèque"> Chèque</label>
        <label class="pill"><input type="radio" name="reglement" value="Carte bleue"> Carte bleue</label>
        <label class="pill"><input type="radio" name="reglement" value="Espèces"> Espèces</label>
        <label class="pill"><input type="radio" name="reglement" value="Licence fin de saison (gratuit)"> Licence fin de saison (gratuit)</label>
      </div>
    </fieldset>

    <!-- Photo -->
    <fieldset>
      <legend>Photo d’identité</legend>
      <label>Ajouter une photo (JPEG/PNG)</label>
      <input type="file" name="photo_identite" accept="image/jpeg,image/png">
      <div class="hint">Optionnel.</div>
    </fieldset>

    <!-- Attestation -->
    <fieldset>
      <legend>Attestation *</legend>
      <label class="pill" style="align-items:flex-start;">
        <input type="checkbox" name="sante_ack" id="sante_ack" required>
        <span>
          J'ai bien pris note de ces questions et comprends que certaines situations ou symptômes peuvent entraîner
          un risque pour ma santé et/ou pour mes performances. J'atteste sur l'honneur avoir déjà pris, ou prendre
          les dispositions nécessaires selon les recommandations données en cas de réponse positive à l'une des
          questions des différents questionnaires.
        </span>
      </label>
    </fieldset>

    <!-- Signature -->
    <fieldset>
      <legend>Signature</legend>
      <div class="sigbox">
        <div class="hint" style="margin-top:0;">Signez dans le cadre ci-dessous (doigt/souris). (Optionnel si vide)</div>
        <canvas id="signaturePad"></canvas>
        <div style="margin-top:8px; display:flex; gap:10px;">
          <button type="button" class="btn btn-ghost" id="clearSig">Effacer</button>
        </div>
      </div>
    </fieldset>

    <!-- Actions -->
    <div class="actions">
      <button type="submit" class="btn btn-primary" id="submitBtn">Envoyer le bulletin</button>
      <button type="button" class="btn btn-ghost" id="resetBtn">Réinitialiser</button>
      <button class="btn btn-ghost no-print" type="button" id="printBtn">Imprimer</button>
      <span class="hint" id="statusMsg" style="margin-left:auto;"></span>
    </div>

  </form>
</div>

<!-- PAGE CONFIRMATION -->
<div class="page hidden" id="confirmPage" style="min-height:auto;">
  <h1>✅ Inscription enregistrée</h1>
  <p>Merci, votre inscription a bien été prise en compte.</p>
  <p><b>N° d’adhésion :</b> <span id="confNum"></span></p>
  <p>
    <a class="btn btn-primary" id="confPdf" target="_blank">Télécharger le PDF</a>
    <button class="btn btn-ghost" id="backBtn" type="button">Faire une autre inscription</button>
  </p>
</div>

<script>
/** ========= CONFIG ========= */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFote2couQvnAFGuZ0A84nGnyGBfJtpZlddwLfZ8Qb1PMeWlad8u6H9biiTz8ubIko1w/exec";

/** ========= Helpers ========= */
function normalizeSpaces(s){ return (s||"").replace(/\s+/g," ").trim(); }
function formatEUR(v){
  const n = Number(v);
  if (!Number.isFinite(n)) return "";
  return n.toFixed(2).replace(".", ",") + " €";
}
function getRadio(form, name){
  return form.querySelector(`input[name="${name}"]:checked`)?.value || "";
}
function getCheckedValues(form, name){
  return Array.from(form.querySelectorAll(`input[name="${name}"]:checked`)).map(x => x.value);
}
function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

const TARIFS_URL = "/parcours/inscriptions/tarifs-2026.json?v=7";

function eur(n){
  const x = Number(n);
  if (!Number.isFinite(x)) return "—";
  return x.toFixed(2).replace(".", ",") + " €";
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadTarifsAndRender(){
  const body = document.getElementById("tarifsBody");
  if (!body) return;

  try {
    const res = await fetch(TARIFS_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Impossible de charger " + TARIFS_URL);
    const data = await res.json();

    // colonnes
    const cols = data.colonnes || ["Mini-braquet","Petit-braquet","Grand-braquet"];
    const c0 = document.getElementById("col0");
    const c1 = document.getElementById("col1");
    const c2 = document.getElementById("col2");
    if (c0) c0.textContent = cols[0] || "Mini-braquet";
    if (c1) c1.textContent = cols[1] || "Petit-braquet";
    if (c2) c2.textContent = cols[2] || "Grand-braquet";

    // build rows
    let html = "";
    for (const g of (data.groupes || [])) {
      html += `<tr class="grp"><td colspan="4">${escapeHtml(g.titre || "")}</td></tr>`;

      for (const ligne of (g.lignes || [])) {
        html += `<tr>
          <td class="label">${escapeHtml(ligne.label || "")}</td>`;

        const prix = ligne.prix || [];
        for (let i = 0; i < 3; i++) {
          const p = prix[i];
          if (!p) {
            html += `<td class="price" style="color:#999;">—</td>`;
            continue;
          }
          html += `<td class="price">
            <label class="radioPrice">
              <input type="radio" name="cotisation_choice" ${/* required only once */""}
                data-code="${escapeHtml(p.code)}"
                data-libelle="${escapeHtml(p.libelle)}"
                data-montant="${escapeHtml(p.montant)}">
              ${eur(p.montant)}
            </label>
          </td>`;
        }
        html += `</tr>`;
      }
    }

    body.innerHTML = html;

    // rendre "required" sur le premier radio du groupe global
    const firstRadio = document.querySelector('input[name="cotisation_choice"]');
    if (firstRadio) firstRadio.required = true;

    // rebrancher listener updateCotisation()
    document.querySelectorAll('input[name="cotisation_choice"]').forEach(el=>{
      el.addEventListener("change", () => {
        updateCotisation();
        validateCotisation?.();
      });
    });

    // préselection via URL ?cotisation_code=
    const params = new URLSearchParams(window.location.search);
		if (params.has("cotisation_code")) {
		  const code = params.get("cotisation_code");
		  const radios = document.querySelectorAll('input[name="cotisation_choice"]');
		  radios.forEach(r => {
		    if (r.dataset.code === code) r.checked = true;
		  });
		}

    updateCotisation();

  } catch (e) {
    console.error(e);
    body.innerHTML = `<tr><td colspan="4" style="padding:8px;color:#b00000;">
      ❌ Tarifs indisponibles. Vérifie le fichier <b>${escapeHtml(TARIFS_URL)}</b>.
    </td></tr>`;
  }
}

/** ========= Signature pad (responsive + retina + empty detection) ========= */
function setupSignaturePad(){
  const canvas = document.getElementById("signaturePad");
  const clearBtn = document.getElementById("clearSig");
  if(!canvas || !clearBtn) return;

  canvas.style.width = "100%";
  canvas.style.maxWidth = "520px";
  canvas.style.height = "130px";

  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  function getPos(e){
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
  }

  function start(e){ drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x,p.y); e.preventDefault(); }
  function move(e){ if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); }
  function end(){ drawing = false; }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);

  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  canvas.addEventListener("touchend", end);

  clearBtn.addEventListener("click", () => ctx.clearRect(0,0,canvas.width,canvas.height));

  function isEmpty(){
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    for (let i = 3; i < img.length; i += 4) {
      if (img[i] !== 0) return false;
    }
    return true;
  }

  return {
    toDataURL: () => canvas.toDataURL("image/png"),
    isEmpty
  };
}

/** ========= Main ========= */
(function(){
  const form = document.getElementById("adhesionForm");
  const formPage = document.getElementById("formPage");
  const confirmPage = document.getElementById("confirmPage");
  const confNum = document.getElementById("confNum");
  const confPdf = document.getElementById("confPdf");
  const backBtn = document.getElementById("backBtn");

  const paysSelect = document.getElementById("pays_naissance");
  const wrapDept = document.getElementById("wrap_departement_naissance");
  const deptInput = form.querySelector('input[name="departement_naissance"]');
  const wrapPaysEtranger = document.getElementById("wrap_pays_etranger");
  const paysDetail = form.querySelector('input[name="pays_naissance_detail"]');

  const licenceInput = document.getElementById("licence");
  const licenceHint = document.getElementById("licence_hint");
  const identiteError = document.getElementById("identite_error");
  const pratiqueError = document.getElementById("pratique_error");
  const cotError = document.getElementById("cotisation_error");

  const cotAff = document.getElementById("cotisation_affiche");
  const cotCode = document.getElementById("cotisation_code");
  const cotLib = document.getElementById("cotisation_libelle");
  const cotMont = document.getElementById("cotisation_montant");

  const resetBtn = document.getElementById("resetBtn");
  const submitBtn = document.getElementById("submitBtn");
  const printBtn = document.getElementById("printBtn");
  const statusMsg = document.getElementById("statusMsg");

  const sig = setupSignaturePad();

  function adhesionType(){
    return form.querySelector('input[name="type_adhesion"]:checked')?.value || "";
  }

  function setPaysUI(){
    const isFrance = (paysSelect.value === "France");
    wrapDept.classList.toggle("hidden", !isFrance);
    deptInput.required = isFrance;
    if (!isFrance) deptInput.value = "";

    wrapPaysEtranger.classList.toggle("hidden", isFrance);
    paysDetail.required = !isFrance;
    if (isFrance) paysDetail.value = "";
  }

  function setLicenceUI(){
    const required = (adhesionType() === "renouvellement");
    licenceInput.required = required;
    licenceHint.textContent = required
      ? "Obligatoire en renouvellement (6 chiffres)."
      : "Optionnel en première adhésion. Obligatoire en renouvellement.";
  }

  function updateCotisation(){
    const r = form.querySelector('input[name="cotisation_choice"]:checked');
    if(!r){
      cotAff.value = "";
      cotCode.value = "";
      cotLib.value = "";
      cotMont.value = "";
      return;
    }
    cotCode.value = r.dataset.code || "";
    cotLib.value = r.dataset.libelle || "";
    cotMont.value = r.dataset.montant || "";
    cotAff.value = (cotLib.value ? cotLib.value + " — " : "") + formatEUR(cotMont.value);
  }

  function validatePratique(){
    const checked = form.querySelectorAll('input[name="pratique"]:checked').length;
    if (checked < 1){
      pratiqueError.style.display = "block";
      pratiqueError.textContent = "Merci de choisir au moins un type de pratique (Route, VTT, Gravel).";
      return false;
    }
    pratiqueError.style.display = "none";
    pratiqueError.textContent = "";
    return true;
  }

  function validateLicence(){
    const type = adhesionType();
    const v = normalizeSpaces(licenceInput.value);

    if (type === "renouvellement"){
      if (!/^[0-9]{6}$/.test(v)){
        identiteError.style.display = "block";
        identiteError.textContent = "Renouvellement : le N° de licence est obligatoire et doit contenir 6 chiffres.";
        return false;
      }
    } else {
      if (v && !/^[0-9]{6}$/.test(v)){
        identiteError.style.display = "block";
        identiteError.textContent = "Le N° de licence doit contenir 6 chiffres (ou laisser vide en première adhésion).";
        return false;
      }
    }
    identiteError.style.display = "none";
    identiteError.textContent = "";
    return true;
  }

  function validateCotisation(){
    const ok = !!form.querySelector('input[name="cotisation_choice"]:checked');
    if (!ok){
      cotError.style.display = "block";
      cotError.textContent = "Merci de sélectionner une cotisation.";
      return false;
    }
    cotError.style.display = "none";
    cotError.textContent = "";
    return true;
  }

  function prefillFromQuery(){
    const params = new URLSearchParams(window.location.search);

    const setVal = (name, value) => {
      const el = form.querySelector(`[name="${name}"]`);
      if (el && typeof value === "string") el.value = value;
    };
    const setRadio = (name, value) => {
      const r = form.querySelector(`input[type="radio"][name="${name}"][value="${value}"]`);
      if (r) r.checked = true;
    };

    ["nom","prenom","nom_naissance","date_naissance","commune_naissance","departement_naissance",
     "adresse","cp","ville","telephone","email","licence","pays_naissance_detail"
    ].forEach(k => { if (params.has(k)) setVal(k, params.get(k)); });

    if (params.has("pays_naissance")){
      const v = params.get("pays_naissance");
      paysSelect.value = (v === "Etranger" || v === "À l’étranger") ? "Etranger" : "France";
    }

    if (params.has("type_adhesion")) setRadio("type_adhesion", params.get("type_adhesion"));
    if (params.has("civilite")) setRadio("civilite", params.get("civilite"));
    if (params.has("vae")) setRadio("vae", params.get("vae"));
    if (params.has("reglement")) setRadio("reglement", params.get("reglement"));

    if (params.has("pratique")){
      (params.get("pratique")||"").split(",").map(s=>s.trim()).filter(Boolean).forEach(v=>{
        const c = form.querySelector(`input[type="checkbox"][name="pratique"][value="${v}"]`);
        if (c) c.checked = true;
      });
    }

    if (params.has("sante_ack")){
      const v = params.get("sante_ack");
      const ack = document.getElementById("sante_ack");
      if (ack) ack.checked = (v === "1" || v === "true" || v === "oui");
    }

    if (params.has("cotisation_code")){
      const code = params.get("cotisation_code");
      const r = form.querySelector(`input[name="cotisation_choice"][data-code="${code}"]`);
      if (r) r.checked = true;
    }

    setPaysUI();
    setLicenceUI();
    updateCotisation();
    validateLicence();
    validatePratique();
    validateCotisation();
  }

  // listeners
  paysSelect.addEventListener("change", setPaysUI);
  form.querySelectorAll('input[name="type_adhesion"]').forEach(r => r.addEventListener("change", () => { setLicenceUI(); validateLicence(); }));
  licenceInput.addEventListener("input", validateLicence);
  form.querySelectorAll('input[name="pratique"]').forEach(c => c.addEventListener("change", validatePratique));
  form.querySelectorAll('input[name="cotisation_choice"]').forEach(el => el.addEventListener("change", () => { updateCotisation(); validateCotisation(); }));
  printBtn.addEventListener("click", () => window.print());

  ["nom","prenom","nom_naissance","commune_naissance","pays_naissance_detail","ville","adresse"].forEach(name=>{
    const input = form.querySelector(`[name="${name}"]`);
    if (!input) return;
    input.addEventListener("blur", () => input.value = normalizeSpaces(input.value));
  });

  resetBtn.addEventListener("click", () => {
    form.reset();
    identiteError.style.display = "none";
    pratiqueError.style.display = "none";
    cotError.style.display = "none";
    statusMsg.textContent = "";
    setPaysUI(); setLicenceUI(); updateCotisation();
  });

  backBtn.addEventListener("click", () => {
    confirmPage.classList.add("hidden");
    formPage.classList.remove("hidden");
    form.reset();
    statusMsg.textContent = "";
    setPaysUI(); setLicenceUI(); updateCotisation();
  });

  // submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusMsg.textContent = "";

    updateCotisation();
    if (!validateCotisation()) return;
    if (!validateLicence() || !validatePratique()) return;
    if (!form.reportValidity()) return;

    const pratiques = getCheckedValues(form, "pratique");
    const cot = form.querySelector('input[name="cotisation_choice"]:checked');

    const payload = {
      year: "2026",

      type_adhesion: getRadio(form, "type_adhesion"),
      civilite: getRadio(form, "civilite"),
      nom: normalizeSpaces(form.nom.value),
      prenom: normalizeSpaces(form.prenom.value),
      nom_naissance: normalizeSpaces(form.nom_naissance.value || ""),
      date_naissance: form.date_naissance.value,
      commune_naissance: normalizeSpaces(form.commune_naissance.value),
      departement_naissance: normalizeSpaces(form.departement_naissance?.value || ""),
      pays_naissance: form.pays_naissance.value,
      pays_naissance_detail: normalizeSpaces(form.pays_naissance_detail?.value || ""),
      licence: normalizeSpaces(form.licence?.value || ""),

      adresse: normalizeSpaces(form.adresse.value),
      cp: normalizeSpaces(form.cp.value),
      ville: normalizeSpaces(form.ville.value),
      telephone: normalizeSpaces(form.telephone.value),
      email: normalizeSpaces(form.email.value),

      pratique: pratiques,
      vae: getRadio(form, "vae"),

      cotisation: {
        code: cot?.dataset.code || "",
        libelle: cot?.dataset.libelle || "",
        montant: cot?.dataset.montant || ""
      },

      reglement: getRadio(form, "reglement"),
      sante_ack: !!document.getElementById("sante_ack")?.checked,

      signature: null,
      client_timestamp: new Date().toISOString()
    };

    if (sig && !sig.isEmpty()) {
      payload.signature = { dataUrl: sig.toDataURL(), mime: "image/png" };
    }

    const photoInput = form.querySelector('input[name="photo_identite"]');
    if (photoInput && photoInput.files && photoInput.files[0]) {
      const f = photoInput.files[0];
      if (f.size > 2.5 * 1024 * 1024) {
        alert("La photo est trop volumineuse (max ~2,5 Mo).");
        return;
      }
      payload.photo = { dataUrl: await fileToDataUrl(f), mime: f.type };
    }

    submitBtn.disabled = true;
    const old = submitBtn.textContent;
    submitBtn.textContent = "Envoi…";
    statusMsg.textContent = "Transmission…";

    try {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const json = await res.json().catch(() => ({}));
      if (!json.ok) throw new Error(json.message || "Erreur lors de l’envoi.");

      document.getElementById("formPage").classList.add("hidden");
      document.getElementById("confirmPage").classList.remove("hidden");
      confNum.textContent = json.adhesionNumber || "(non fourni)";
      confPdf.href = json.pdfUrl || "#";

    } catch (err) {
      console.error(err);
      statusMsg.textContent = "❌ Échec de l’envoi.";
      alert("❌ " + (err.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = old;
      statusMsg.textContent = "";
    }
  });

  // init
  setPaysUI();
  setLicenceUI();
  updateCotisation();
  prefillFromQuery();
  loadTarifsAndRender();
})();
</script>

</body>
</html>
